# コマンド処理のテストガイド

このドキュメントでは、実装したコマンド処理をテストする方法を説明します。

## テスト方法

### 1. 単体テストの実行

#### 前提条件
- .NET 8.0 SDK がインストールされていること
- Visual Studio または Visual Studio Code がインストールされていること

#### テストプロジェクトの追加

ソリューションにテストプロジェクトを追加します：

```bash
dotnet sln add Wideor_A23.Tests.csproj
```

#### テストの実行

**コマンドラインから実行：**
```bash
dotnet test
```

**Visual Studio から実行：**
1. テストエクスプローラーを開く（`Ctrl+Alt+T`）
2. 「すべてのテストを実行」をクリック

**特定のテストクラスのみ実行：**
```bash
dotnet test --filter "FullyQualifiedName~CommandParserTests"
dotnet test --filter "FullyQualifiedName~CommandExecutorTests"
```

### 2. 手動テスト（アプリケーション内でテスト）

#### テスト用サンプルファイルの使用

1. `test_sample.wideor` ファイルを開く
2. エディタにコマンドが表示されることを確認
3. 各コマンドが正しくパースされることを確認

#### テスト手順

**LOAD コマンドのテスト：**
```
LOAD video.mp4
```
- エディタに入力
- パースが成功することを確認
- セグメントが作成されることを確認（Timelineで確認）

**CUT コマンドのテスト：**
```
CUT 00:01:23.456
```
- エディタに入力
- パースが成功することを確認
- セグメントが2つに分割されることを確認

**HIDE/SHOW コマンドのテスト：**
```
HIDE 00:01:00.000 00:01:30.000
SHOW 00:01:00.000 00:01:30.000
```
- エディタに入力
- セグメントが非表示/表示されることを確認（Timelineで確認）

**DELETE コマンドのテスト：**
```
DELETE 00:00:30.000 00:01:00.000
```
- エディタに入力
- セグメントが削除されることを確認

**MERGE コマンドのテスト：**
```
MERGE 00:01:00.000 00:02:00.000
```
- エディタに入力
- 隣接するセグメントが結合されることを確認

**SPEED コマンドのテスト：**
```
SPEED 1.5x 00:01:00.000 00:01:30.000
```
- エディタに入力
- セグメントのSpeedRateが更新されることを確認

### 3. 統合テスト（エディタとTimelineの連携）

1. **エディタでコマンドを入力**
   - `EditorView.xaml` でテキストを入力

2. **コマンドがパースされることを確認**
   - `EditorViewModel` がコマンドをパース
   - `CommandParser` が正しく動作

3. **コマンドが実行されることを確認**
   - `CommandExecutor` がコマンドを実行
   - `VideoSegmentManager` にセグメントが追加/更新/削除される

4. **Timelineで結果を確認**
   - `TimelineViewModel` でセグメントが表示される
   - `FilmStripView` でセグメントが正しく表示される

### 4. エラーハンドリングのテスト

**無効なコマンドのテスト：**
```
INVALID_COMMAND
CUT invalid_time
HIDE 00:01:00.000  # 終了時間が不足
```

- エラーメッセージが表示されることを確認
- アプリケーションがクラッシュしないことを確認

**境界値のテスト：**
```
CUT 00:00:00.000  # 開始位置
CUT 00:10:00.000  # 終了位置
SPEED 0.1x 00:01:00.000 00:01:30.000  # 最小速度
SPEED 10.0x 00:01:00.000 00:01:30.000  # 最大速度
```

### 5. パフォーマンステスト

大量のコマンドを処理するテスト：

```bash
# 1000個のCUTコマンドを生成
for i in {1..1000}; do echo "CUT 00:00:$(printf "%02d" $((i/60))).$(printf "%03d" $((i%60*1000/60)))"; done > large_test.wideor
```

- パース時間を測定
- メモリ使用量を確認
- UIがフリーズしないことを確認

## デバッグ方法

### ログの確認

`LogHelper` が出力するログを確認：

```csharp
// CommandExecutor のログ
LogHelper.WriteLog("CommandExecutor:ExecuteCut", "CUT command completed", ...);
```

### ブレークポイントの設定

1. `CommandParser.ParseLine` にブレークポイントを設定
2. `CommandExecutor.ExecuteCommandWithResult` にブレークポイントを設定
3. ステップ実行で動作を確認

## 期待される動作

### 正常系

- ✅ すべてのコマンドが正しくパースされる
- ✅ コマンドが正しく実行される
- ✅ セグメントが正しく作成/更新/削除される
- ✅ Timelineで結果が正しく表示される

### 異常系

- ✅ 無効なコマンドはエラーメッセージを返す
- ✅ アプリケーションがクラッシュしない
- ✅ エラーログが出力される

## トラブルシューティング

### テストが失敗する場合

1. **パースエラー**
   - 正規表現パターンを確認
   - テストデータの形式を確認

2. **実行エラー**
   - `VideoSegmentManager` のモックが正しく設定されているか確認
   - セグメントの状態を確認

3. **統合テストエラー**
   - DIコンテナの設定を確認
   - 依存関係を確認

## 参考資料

- [xUnit ドキュメント](https://xunit.net/)
- [Moq ドキュメント](https://github.com/moq/moq4)

## 1. プロジェクト概要

* **Product Name**: Wideor (ウィデオ)
* **Concept**: 動画を綴る
* **Philosophy**: 書かれたテキストがすべて
* **Target User**: 現場職人、年配者、パソコン操作が不慣れな方

## 2. 技術スタック & アーキテクチャ

### 2.1 推奨環境
* **Framework**: .NET 8.0 (Desktop)
* **GUI Framework**: WPF (Windows Presentation Foundation)
* **Architecture Pattern**: MVVM (Model-View-ViewModel) with `CommunityToolkit.Mvvm`

### 2.2 主要ライブラリ
使い慣れているWordに似たUI設計を目指して以下を使用する。（以下は現状）
* **Text Editor**: `ICSharpCode.AvalonEdit` (wordライクな捜査官)
* **UI Controls**: `Fluent.Ribbon` (Officeライクなヘッダー), `MaterialDesignInXamlToolkit` (アイコン等のUI)
* **Video Engine**: `FFmpeg.AutoGen` または `LibVLCSharp` (高パフォーマンスなサムネイル抽出と再生のため)

````

---

## 3. UI仕様 (4-Column Integrated Scroll Layout)

画面は縦スクロールのみを許す。横にスクロールするという動作を持たない。イメージはwordである。これは投影機の再生フィルムと文書作成ソフトの編集部分のアナロジーを根源としている。
ViewPortの中央（Y = 50%）に「赤いインジケータ（Playhead）」を物理固定し、背景コンテンツ側を移動させる。
### 3.1 カラム定義 (左から右へ)

| **ID** | **名称**              | **幅** | **役割**                  | **実装について**                            |
| ------ | ------------------- | ----- | ----------------------- | ------------------------------------- |
| **C1** | **Time Ruler Area** | 60px  | 時間目盛りの表示                | ズーム率(PixelsPerSecond)に応じた動的描画         |
| **C2** | **Film Area**       | 可変    | フレーム・クリップのサムネイルの表示      | `Canvas` または `VirtualizingStackPanel` |
| **C3** | **Link Area**       | 80px  | クリップとパラグラフを対応関係を表す台形の描画 | `Canvas` + `BezierSegment`            |
| **C4** | **Text Area**       | 残り全て  | パラグラフの作成                | `AvalonEdit:TextEditor`               |

### 3.2 フィルムエリア
動画というものを、静止画の連続体と考える。つまり、膨大な数の写真を高速で切り替えて動きがあるように見せるものを動画ととらえる。Wideorにおける動画編集とは、元動画の中から必要な静止画を選んだり静止画そのものを作成したりして、動画を再構築する作業のことである。
フレームとは、動画に対して最小の単位時間に区切った静止画のことである。任意のフレームまとまりをクリップという。ただし、クリップのまとまりは動画である。フィルムエリアはクリップを持っている。フィルムエリアでの作業はクリップの作成といえる。詳細に説明すると、クリップエリアでは、動画を構成するのに必要なフレームを選択してクリップを作成する。

フレーム(C2)は、以下の2つの状態を持つ。
- **Active (選択中)：
	- 明るい(Opacity 1.0)
	- テキストエリアにコマンド行が存在する時間帯
    
-  **Inactive (未選択)**: 
	- 暗い(Opacity 0.3 + Grayscale)。
	- コマンド行が存在しない時間帯

### 3.3 リンクエリア
リンクエリアはクリップとパラグラフをつなぐ役割にある。言い換えると、クリップとパラグラフとの対応関係を明確に表示する領域である。具体的には、クリップ、パラグラフそれぞれのはじめと終わりに線が引いてあり、始点と終点を結んだときに得られる台形が表示されているエリアである。始点と終点を結ぶ線を対応線という

### 3.4 テキストエリア
テキストエリアは、パラグラフを作成する役割である。ここで、パラグラフとは、クリップに表示する文字列を表す挿入文字、パラグラフを形作る指示文からなる一つの単位である。言い換えると、クリップとの対応に用いる最小構成を表す言い方である。これは、文書におけるまとまりをもつ単位であるパラグラフからのアナロジーである。別の表現をすれば、クリップを装飾するための要素である。
挿入文字には３つに分類できる。題名、字幕、補足文である。題名は動画上部に描画されるものである。基本は左詰めである。字幕は、動画の内容について説明等をする役割である。画面下部に置かれるものである。配置は中央で左詰めが基本である。補足文は字幕で補えきれなかったものを画面の任意の場所に配置するものである。

### 3.5 その他エリアについて
リボンUIとステータスを表示するエリアをそれぞれ、上部と下部に設ける。
リボンでは、動画編集に関する個々の操作を持つようにする。以下のようにタブを区切る（仮）
- ファイル：保存、インポート、エクスポート等のボタン
- 基本操作：基本の編集作業についてのボタン
- 要素追加：空のクリップ、動画、画像、図形、表、数式などを挿入するボタン
- 飾り付け：全体のデザインについてのボタン
- 確認：プレビュー等のボタンを挿入
- ヘルプ：操作の説明、チュートリアルなど

---

## 4. データ構造と解析ロジック

### 4.1 テキストフォーマット (The Source of Truth)

ファイル保存形式はプロジェクトを表す.wideorである。
以下の正規表現ルールに基づく。
「Markdownの水平線」と「TeXの引数記法」を融合させた、視認性の高いセパレータを採用する。

* **Syntax**: `--- [Start -> End] ---`
* **RegEx**: `^[-]{3,}\s*\[(?<start>\d{2}:\d{2}:\d{2}\.\d{3})\s*->\s*(?<end>\d{2}:\d{2}:\d{2}\.\d{3})\]\s*[-]{3,}$`

#### フォーマット例
text
(前の段落)

--- [00:01:15.000 -> 00:01:20.500] ---
1. ここでボルトを緩めます。

--- [00:04:10.000 -> 00:04:15.000] ---
2. 次にカバーを外します。
### 4.2 内部データモデル (Runtime Model)

テキストをパースし、以下のコレクションを生成してViewModelで保持する。

C#
public class SceneBlock
{
    public TimeSpan StartTime { get; set; }
    public TimeSpan EndTime { get; set; }
    public int CommandLineLineNumber { get; set; } // エディタ上の行番号
    public string ContentText { get; set; }        // コマンド行以下のテキスト
}


## 5. 動作仕様 (Behavior Rules)

### 5.1 クリップ作成手順 (Smart Anchor System)

単一のボタン操作により、スクロール方向に応じて「始点」「終点」を動的に判定する。

1.  **UI配置**:
    * Center Indicator（赤線）の右端に単一の `AnchorButton` を配置。
    * **States**:
        * `Idle`: 未選択状態 (Icon: "⚓", Label: "範囲指定")
        * `Active`: 範囲選択中 (Icon: "✅", Label: "確定")
2.  **Interaction Flow**:
    * **Step 1: First Click (Pivot Setting)**
        * ユーザーが `AnchorButton` (Idle) をクリック。
        * **Action**:
            * 現在の `CurrentTime` を `PivotTime` として保持。
            * UIステートを `Active` に変更。
            * エディタ上のカーソル位置に「空のセパレータ行」を仮挿入。
    * **Step 2: Scroll (Dynamic Banding)**
        * ユーザーがスクロール操作を行う。
        * **Visual Feedback**:
            * `CurrentTime` > `PivotTime` の場合: `Pivot`から下へ帯を伸ばす（順方向）。
            * `CurrentTime` < `PivotTime` の場合: `Pivot`から上へ帯を伸ばす（逆方向）。
            * 帯は半透明で描画し、選択範囲を可視化する。
    * **Step 3: Second Click (Confirmation)**
        * ユーザーが `AnchorButton` (Active) をクリック。
        * **Action**:
            * `PivotTime` と `CurrentTime` を比較し、小さい方を `Start`、大きい方を `End` とする。
            * 仮挿入していたセパレータ行に `[Start - End]` を確定書き込み。
            * UIステートを `Idle` にリセット。
3.  **Cancellation**:
    * `Active` 状態で `Esc` キー、またはボタンの右クリック等でキャンセル可能とし、仮挿入したセパレータを削除する。

### 5.2 リンク描画 (Rendering)
Link Area(C3)には、以下の座標を結ぶ線を描画する。
- **左端**: Film Area上の `Y_Top`, `Y_Bottom` (時間から算出される座標)
- **右端**: Text Area上の `Line_Y_Top`, `Line_Y_Bottom` (コマンド行と次のコマンド行までの高さ)
- 拡大縮小に対しては、サムネイル上に対応する位置に線を描画するように変更
## 6. 再生・プレビュー仕様 (Preview Mode)
### 6.1 シアター再生
1. **Trigger**: リボンのシアター再生を選択
2. **Layout Change**:
    - プレイヤーのY座標は画面中央（インジケータ位置）に固定。
3. **Auto Scroll**
    - 動画の再生時間(t)に合わせて、背景全体をスクロールさせる。
    - `ScrollY = TimeToPixels(t)`
4. **Skip Logic**:
    - 再生ヘッドが「Inactive（暗）」な時間に到達したら、次の「Active（明）」な時間の開始点まで即座にシークする。
### 6.2 プレビュー再生
1. Trigger：リボンのプレビュー再生を選択
2. 動作:
	- テキストに書かれている編集をもとにシーンを再生する 
	- プレビュー動画オーバーレイされる
	- 一般的な動画再生プレイヤーと同様